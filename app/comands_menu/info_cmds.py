import os
import logging
from aiogram import Router, Bot
from aiogram.types import Message
from aiogram.exceptions import TelegramBadRequest
from aiogram.filters import Command
from sqlalchemy.ext.asyncio import AsyncSession

from app.db.crud import closed_menu
from app.redis_client import redis_client


logger = logging.getLogger(__name__)
info_router = Router()


tech_channel_id = int(os.getenv("TECH_CHANNEL_ID"))
guide_post = int(os.getenv("GUIDE_POST"))
rules_post = int(os.getenv("RULES_POST"))
service_post = int(os.getenv("SERVICE_POST"))


@info_router.message(Command("guide"))
async def what_cmd(message: Message, bot:Bot, session: AsyncSession):
    if await closed_menu(message=message, session=session):
        return
    # # 1. –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ Redis (PRO —Å–ø–æ—Å–æ–±)
    # # –ú—ã –∏—â–µ–º file_id, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –ø–æ–¥ –∏–º–µ–Ω–µ–º "intro_video"
    # video_id = await redis_client.get("media:guide_post")
    text = (f"üìù <b>–®–ø–∞—Ä–≥–∞–ª–∫–∞: ¬´–ß—Ç–æ –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ –ø–æ–¥–±–æ—Ä–µ¬ª</b>"
            f"\n\n<b>1. –û—Å–Ω–æ–≤–∞:</b>"
            f"\n\n‚Ä¢ –¢–∏–ø –∫–æ–ª—è—Å–∫–∏ (–æ—Ç —Ä–æ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫–∞)"
            f"\n‚Ä¢ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (2–≤1, 3–≤1 –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ª—é–ª—å–∫–∞)"
            f"\n‚Ä¢ –§–æ—Ä–º–∞—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫ –∏–ª–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π)"
            f"\n‚Ä¢ –°–µ–∑–æ–Ω (–∑–∏–º–∞ –∏–ª–∏ –ª–µ—Ç–æ)"
            f"\n‚Ä¢ –¢–∏–ø –¥–æ—Ä–æ–≥ (–≥—Ä—É–Ω—Ç, –∞—Å—Ñ–∞–ª—å—Ç –∏–ª–∏ –±–µ–∑–¥–æ—Ä–æ–∂—å–µ)"
            f"\n\nüëÜ <i>–≠—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –º—ã –∑–∞–∫—Ä—ã–ª–∏ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ, –∫–æ–≥–¥–∞ –≤—ã –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –∫–≤–∏–∑-–æ–ø—Ä–æ—Å. –≠—Ç–æ –±–∞–∑–∞ (—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç) "
            f"–¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–¥–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∫–æ–ª—è—Å–∫–∏</i>"
            f"\n\n<b>2. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ –Ω—é–∞–Ω—Å—ã (–Ω–∞ —ç—Ç–æ–º —á–∞—Å—Ç–æ ¬´—Å–ø–æ—Ç—ã–∫–∞—é—Ç—Å—è¬ª):</b>"
            f"\n<i>–ù–µ–≥–∞—Ç–∏–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ —ç—Ç–∏—Ö –¥–µ—Ç–∞–ª–µ–π –≤—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞ —Å–µ–±–µ —É–∂–µ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏, –µ—Å–ª–∏ "
            f"–Ω–µ —É—á—Ç–µ—Ç–µ –∏—Ö —Å–µ–π—á–∞—Å</i>"
            f"\n\n‚Ä¢ –®–∏—Ä–∏–Ω–∞ –ª–∏—Ñ—Ç–∞ (–≤–æ–∑—å–º–∏—Ç–µ —Ä—É–ª–µ—Ç–∫—É –∏ –∑–∞–º–µ—Ä—å—Ç–µ –¥–≤–µ—Ä–∏. –ï—Å–ª–∏ –∫–æ–ª—è—Å–∫–∞ –æ–∫–∞–∂–µ—Ç—Å—è —à–∏—Ä–µ –ø—Ä–æ–µ–º–∞ "
            f"–≤—Å–µ–≥–æ –Ω–∞ 1 —Å–º ‚Äî –±—É–¥–µ—Ç–µ –Ω–æ—Å–∏—Ç—å –µ—ë –∏ —Ä–µ–±–µ–Ω–∫–∞ –Ω–∞ —Ä—É–∫–∞—Ö)"
            f"\n‚Ä¢ –ì–ª—É–±–∏–Ω–∞ –±–∞–≥–∞–∂–Ω–∏–∫–∞ –í–∞—à–µ–≥–æ –∞–≤—Ç–æ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω —Ç–∏–ø —Å–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è –∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å)"
            f"\n‚Ä¢ –í–∞—à —Ä–æ—Å—Ç (–≤—ã—Å–æ–∫–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–∏ —á–∞—Å—Ç–æ –ø–∏–Ω–∞—é—Ç –Ω–æ–≥–∞–º–∏ –æ—Å—å –∑–∞–¥–Ω–∏—Ö –∫–æ–ª–µ—Å —É –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö –∫–æ–ª—è—Å–æ–∫, "
            f"–¥–ª—è –≤—ã—Å–æ–∫–∏—Ö –Ω—É–∂–Ω–∞ —Ä–∞–º–∞ —Å –≤—ã–Ω–µ—Å–µ–Ω–Ω–æ–π –Ω–∞–∑–∞–¥ –æ—Å—å—é –∏–ª–∏ —Ç–µ–ª–µ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è —Ä—É—á–∫–∞)"
            f"\n‚Ä¢ –≠—Ç–∞–∂–Ω–æ—Å—Ç—å –∏ –Ω–∞–ª–∏—á–∏–µ –ª–∏—Ñ—Ç–∞ (5-–π —ç—Ç–∞–∂ –±–µ–∑ –ª–∏—Ñ—Ç–∞ = –º–∞–º–∞ –ø–æ—Å–ª–µ –∫–µ—Å–∞—Ä–µ–≤–∞ –Ω–µ –ø–æ–¥–Ω–∏–º–µ—Ç –∫–æ–ª—è—Å–∫—É –≤–µ—Å–æ–º 16 –∫–≥)"
            f"\n‚Ä¢ –≠—Ä–≥–æ–Ω–æ–º–∏–∫–∞ (–≥–ª—É–±–∏–Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∫–∞–ø–æ—Ä–∞, —É–≥–æ–ª –æ—Ç–∫–∏–¥—ã–≤–∞–Ω–∏—è —Å–ø–∏–Ω–∫–∏, —Å–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–π —Ä—É–∫–æ–π, "
            f"–∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –∏ —Ç.–¥.)"
            f"\n‚Ä¢ –ë—é–¥–∂–µ—Ç (–Ω–µ –Ω—É–∂–Ω–æ –±—Ä–∞—Ç—å –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞ –∫–æ–ª—è—Å–∫—É - –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Å —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º—ã–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏)"
            f"\n‚Ä¢ –î–∏–∑–∞–π–Ω –∏ —Ü–≤–µ—Ç (–≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–æ–ª—è—Å–∫–∏ –¥–æ–ª–∂–µ–Ω —Ä–∞–¥–æ–≤–∞—Ç—å –º–∞–º—É üòç)"
            f"\n\nüí° –≠—Ç–æ –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–µ—Ä–∂–∞—Ç—å –≤ –≥–æ–ª–æ–≤–µ –ø—Ä–∏ –ø–æ–¥–±–æ—Ä–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞"
            f"\n\n–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ —É—Å–ª–æ–≤–∏—è, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏–ª–∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ "
            f"ü§ñAI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É –∏ –æ–Ω —Å–∞–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –ø–æ–¥—Ö–æ–¥—è—Ç –ø–æ –≥–∞–±–∞—Ä–∏—Ç–∞–º –∏–ª–∏ —Ü–µ–Ω–µ"
            f"\n\n–ù–∞–ø–∏—à–∏—Ç–µ –µ–º—É –∫–∞–∫ –µ—Å—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: "
            f"<blockquote>¬´–ñ–∏–≤—É –Ω–∞ 5 —ç—Ç–∞–∂–µ –±–µ–∑ –ª–∏—Ñ—Ç–∞, —É–∑–∫–∏–µ –¥–≤–µ—Ä–∏, –º—É–∂ –≤—ã—Å–æ–∫–∏–π, –±—é–¥–∂–µ—Ç 40–∫¬ª</blockquote>"
            f"\n\n/ai_consultant ‚Äî <b>–ù–∞—á–∞—Ç—å —É–º–Ω—ã–π –ø–æ–¥–±–æ—Ä</b>"
            f"\n\n/quiz_restart ‚Äî <b>–ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ –∫–≤–∏–∑ (–±–∞–∑—É)</b>"
            )

    # === –ü–û–ü–´–¢–ö–ê 1: REDIS (–¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–∞—è) ===
    video_id = await redis_client.get("media:guide_post")
    if video_id:
        try:
            await message.answer_video(
                video=video_id,
                caption=f"<b>–ï—Å–ª–∏ –≤–∏–¥–µ–æ –¥–æ–ª–≥–æ –≥—Ä—É–∑–∏—Ç—Å—è –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ —Ç—É—Ç:</b>"
                        f"\n\nYouTube - https://www.youtube.com/"
                        f"\n\nRUTUBE - https://rutube.ru/"
                        f"\n\nVK –í–∏–¥–µ–æ - https://vkvideo.ru/"
            )
            await message.answer(text=text)
            print(f"üîî –ü–û–ü–´–¢–ö–ê 1: Redis)")
            return  # –£—Å–ø–µ—Ö, –≤—ã—Ö–æ–¥–∏–º
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ video_note –∏–∑ Redis: {e}")

    # 2. FALLBACK 1: –ï—Å–ª–∏ –≤ Redis –ø—É—Å—Ç–æ, –ø—Ä–æ–±—É–µ–º copy_message (–°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)
    # –≠—Ç–æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ç—ã –∑–∞–±—ã–ª –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ –≤ —Ç–µ—Ö.–∫–∞–Ω–∞–ª
    try:
        await bot.copy_message(
            chat_id=message.chat.id,
            from_chat_id=tech_channel_id,  # ID —Ç–µ—Ö –∫–∞–Ω–∞–ª–∞
            message_id=guide_post,  # ID —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≥—Ä—É–ø–ø—ã
            caption=f"<b>–ï—Å–ª–∏ –≤–∏–¥–µ–æ –¥–æ–ª–≥–æ –≥—Ä—É–∑–∏—Ç—Å—è –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ —Ç—É—Ç:</b>"
                    f"\n\nYouTube - https://www.youtube.com/"
                    f"\n\nRUTUBE - https://rutube.ru/"
                    f"\n\nVK –í–∏–¥–µ–æ - https://vkvideo.ru/"
        )
        await message.answer(text=text)
        print(f"üîî –ü–û–ü–´–¢–ö–ê 2: –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –∏–∑ –∫–∞–Ω–∞–ª–∞)")
        return
    except Exception as e:
        logger.error(f"‚ùå FALLBACK 1 failed: {e}")

    logger.error("‚ùå Redis –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
    await message.answer(
        text=f"<b>–í—ã–±–µ—Ä–∏—Ç–µ, –≥–¥–µ –í–∞–º —É–¥–æ–±–Ω–µ–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ:</b>"
             f"\n\nYouTube - https://www.youtube.com/"
             f"\n\nRUTUBE - https://rutube.ru/"
             f"\n\nVK –í–∏–¥–µ–æ - https://vkvideo.ru/"
             f"\n\n{text}"
    )






@info_router.message(Command("rules"))
async def where_cmd(message: Message, session: AsyncSession):

    if await closed_menu(message=message, session=session):
        return

    await message.answer(f" 1. –ö–∞—Ä—É—Å–µ–ª—å –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–æ–≤ –æ –ø—Ä–∞–≤–∏–ª–∞—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏"
                         f"\n\n 2. –ü—Ä–∏–∑—ã–≤ –ø–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª 'üíä –ö–∞–∫ –ø—Ä–æ–¥–ª–∏—Ç—å –∂–∏–∑–Ω—å –∫–æ–ª—è—Å–∫–µ'")




@info_router.message(Command("service"))
async def when_cmd(message: Message, session: AsyncSession):

    if await closed_menu(message=message, session=session):
        return

    await message.answer(f" 1. –ö–∞—Ä—É—Å–µ–ª—å –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–æ–≤ –æ –¢–û –¥–µ—Ç—Å–∫–æ–π –∫–æ–ª—è—Å–∫–∏"
                         f"\n\n 2. –ó–∞–ø—É—Å–∫ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –ø–ª–∞–Ω–æ–≤–æ–≥–æ –¢–û")