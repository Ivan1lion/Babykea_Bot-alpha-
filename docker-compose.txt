version: '3.8'

# ==========================================
# 1. –û–ë–©–ò–ï –¢–û–ú–ê (–î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–•)
# ==========================================
volumes:
  postgres_data:
  redis_data:
  caddy_data:     # –ó–¥–µ—Å—å Caddy —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
  caddy_config:

# ==========================================
# 2. –ò–ó–û–õ–ò–†–û–í–ê–ù–ù–ê–Ø –°–ï–¢–¨
# ==========================================
networks:
  bot_network:
    driver: bridge

services:
  # === üêò –ë–ê–ó–ê –î–ê–ù–ù–´–• POSTGRESQL ===
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-Babykea_Bot_alpha}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-Babykea_Bot_alpha}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - bot_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-Babykea_Bot_alpha} -d ${POSTGRES_DB:-Babykea_Bot_alpha}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # === ‚ö° REDIS (–ö–≠–® –ò FSM) ===
  redis:
    image: redis:alpine
    restart: always
    # –í–∫–ª—é—á–∞–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è Redis, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ .env
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - bot_network
    healthcheck:
      # –ü–∏–Ω–≥—É–µ–º Redis —Å —É—á–µ—Ç–æ–º –ø–∞—Ä–æ–ª—è
      test: ["CMD", "sh", "-c", "redis-cli -a $$REDIS_PASSWORD ping | grep PONG"]
      interval: 5s
      timeout: 5s
      retries: 5

  # === ü§ñ –¢–í–û–ô TELEGRAM –ë–û–¢ ===
  bot:
    build: .
    restart: always
    env_file:
      - .env
    volumes:
      # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∞–ø–∫—É —Å ChromaDB –Ω–∞—Ä—É–∂—É –¥–ª—è –±–µ–∫–∞–ø–æ–≤
      # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –≤ Dockerfile WORKDIR /app
      - ./chromadb_storage:/app/chromadb_storage
    networks:
      - bot_network
    # üî• –ì–ª–∞–≤–Ω–∞—è –º–∞–≥–∏—è: –±–æ—Ç –∂–¥–µ—Ç –ü–û–õ–ù–û–ô –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  # === üîÑ –í–û–†–ö–ï–† –û–ë–ù–û–í–õ–ï–ù–ò–Ø –í–ï–ö–¢–û–†–û–í (10 –î–ù–ï–ô) ===
  vector_updater:
    build: . # –°–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ —Ç–æ–≥–æ –∂–µ Dockerfile, —á—Ç–æ –∏ –±–æ—Ç
    restart: always
    env_file:
      - .env
    volumes:
      # –†–∞–∑–¥–µ–ª—è–µ—Ç —Ç—É –∂–µ —Å–∞–º—É—é –ø–∞–ø–∫—É –ë–î —Å –±–æ—Ç–æ–º!
      - ./chromadb_storage:/app/chromadb_storage
    networks:
      - bot_network
    depends_on:
      db:
        condition: service_healthy
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª: —Å–∫—Ä–∏–ø—Ç -> —Å–æ–Ω 10 –¥–Ω–µ–π (864000 —Å–µ–∫—É–Ω–¥) -> –ø–æ–≤—Ç–æ—Ä
    # –ó–∞–º–µ–Ω–∏ "app/scripts/update_vectors.py" –Ω–∞ —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    command: >
      /bin/sh -c "
      while true; do
        echo 'üöÄ –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ChromaDB...';
        python update_vectors.py;
        echo 'üí§ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–ø–ª—é 10 –¥–Ω–µ–π...';
        sleep 864000;
      done
      "

  # === üìä METABASE (–ê–ù–ê–õ–ò–¢–ò–ö–ê) ===
  metabase:
    image: metabase/metabase:latest
    restart: always
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: ${POSTGRES_DB:-Babykea_Bot_alpha}
      MB_DB_PORT: 5432
      MB_DB_USER: ${POSTGRES_USER:-Babykea_Bot_alpha}
      MB_DB_PASS: ${POSTGRES_PASSWORD}
      MB_DB_HOST: db
    networks:
      - bot_network
    depends_on:
      db:
        condition: service_healthy
    ports:
      # üõ° –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–≤–µ—Ä–∞ (SSH —Ç—É–Ω–Ω–µ–ª—å)
      - "127.0.0.1:3000:3000"

  # === üåê CADDY (HTTPS REVERSE PROXY) ===
  caddy:
    image: caddy:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443" # –ü–æ—Ä—Ç –¥–ª—è Webhook Telegram
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - bot_network
    depends_on:
      - bot


üí° 3 –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:
–ü—É—Ç—å –∫ update_vectors.py:
–í –±–ª–æ–∫–µ vector_updater —è –Ω–∞–ø–∏—Å–∞–ª python update_vectors.py. –ï—Å–ª–∏ —Ç–≤–æ–π —Ñ–∞–π–ª –ª–µ–∂–∏—Ç –≤ –ø–∞–ø–∫–µ app/services/ (–∏–ª–∏ –≥–¥–µ-—Ç–æ –µ—â–µ),
–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤—å –ø—É—Ç—å –≤ —Å—Ç—Ä–æ–∫–µ command, –Ω–∞–ø—Ä–∏–º–µ—Ä: python app/services/update_vectors.py.

–ü–∞–ø–∫–∞ chromadb_storage:
–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É - ./chromadb_storage:/app/chromadb_storage. –ú—ã –≤—ã–Ω–µ—Å–ª–∏ –ø–∞–ø–∫—É ChromaDB –≤ –ª–æ–∫–∞–ª—å–Ω—É—é
–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–µ—Ä–≤–µ—Ä–∞ (—Ä—è–¥–æ–º —Å —Ç–≤–æ–∏–º docker-compose.yml). –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ö–ª–æ–¥–∞ —Å –±—ç–∫–∞–ø–∞–º–∏! –¢–µ–±–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–ø–∞–ø–∫—É chromadb_storage –ø–æ FTP, –∏ –±–∞–∑–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

Caddyfile:
–ü–æ–ª–æ–∂–∏ –≤ —ç—Ç—É –∂–µ –ø–∞–ø–∫—É (–≥–¥–µ docker-compose.yml) —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º Caddyfile. –ï—Å–ª–∏ —Ç–≤–æ–π –¥–æ–º–µ–Ω
bot.mastermanifest.ru, –≤ —Ñ–∞–π–ª–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ–≥–æ 3 —Å—Ç—Ä–æ–∫–∏:

bot.mastermanifest.ru {
    reverse_proxy bot:8000
}

–¢–µ–ø–µ—Ä—å —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç –∑–∞—â–∏—â–µ–Ω —Å–æ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω. –ë—ç–∫–∞–ø—ã –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∞–ø–∫–∏, Webhook –∑–∞—â–∏—â–µ–Ω SSL,
Metabase –Ω–µ —Ç–æ—Ä—á–∏—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –∞ –≤–µ–∫—Ç–æ—Ä—ã –∫–æ–ª—è—Å–æ–∫ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –Ω–∞ –ø–æ–ª–Ω–æ–º –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–µ –∫–∞–∂–¥—ã–µ 10 —Å—É—Ç–æ–∫.